<!DOCTYPE html>
<html lang="zh-CN">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta charset="UTF-8" />
  <!-- 移动端优先：375px 设计稿，适配 iOS / Android 手机浏览器 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>三十周年校庆祝福 · H5</title>
  <style>
    :root {
      --paper-bg: #f4e4bc;
      --main-red: #8b1e1e;
      --deep-brown: #4b3621;
      --light-paper: #f9f0d6;
      --ink: #3b2a1a;
      --gold: #f7e3a1;
      --light-card: #fbf5e4;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100%;
      min-height: 100dvh;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB",
        "Microsoft YaHei", "Songti SC", "STSong", serif;
      background-color: var(--paper-bg);
      color: var(--ink);
      scroll-behavior: smooth;
      /* iOS 安全区域，适配刘海屏 */
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* 375px 设计稿，移动端优先，仅适配手机浏览器 */
    .page {
      min-height: 100vh;
      min-height: 100dvh; /* 动态视口高度，适配移动端地址栏 */
      width: 100%;
      max-width: 375px;
      margin: 0 auto;
      padding: 16px;
      position: relative;
    }

    .page::before,
    .page::after {
      content: "";
      position: fixed;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      pointer-events: none;
      border-radius: 8px;
      border: 2px solid rgba(75, 54, 33, 0.85);
      z-index: 10;
    }

    .page::after {
      top: 16px;
      left: 16px;
      right: 16px;
      bottom: 16px;
      border: 1px solid rgba(75, 54, 33, 0.7);
    }

    .page-inner {
      position: relative;
      z-index: 1;
      padding: 8px 6px 40px;
    }

    h1, h2, h3, p {
      margin: 0;
    }

    .serif-title {
      font-family: "Songti SC", "STSong", "SimSun", "Times New Roman", serif;
      letter-spacing: 0.08em;
    }

    .section {
      padding: 24px 12px;
      scroll-snap-align: start;
    }

    /* 首屏 */
    .hero {
      min-height: 100vh; /* 首屏铺满高度 */
      display: flex;
      flex-direction: column;
      justify-content: flex-end; /* 按钮置于底部 */
      align-items: center;
      text-align: center;
      position: relative;
      /* 使用校园秋景作为首屏背景，contain 确保图片完整呈现不裁剪 */
      background-color: var(--paper-bg);
      background-image: url("background2.png");
      background-size: contain;
      background-position: center center;
      background-repeat: no-repeat;
    }

    .hero-ribbon {
      margin-top: 16px;
      padding: 6px 24px;
      background: linear-gradient(135deg, #7a1515, var(--main-red));
      color: var(--gold);
      border-radius: 999px;
      border: 1px solid rgba(247, 227, 161, 0.8);
      box-shadow: 0 3px 6px rgba(75, 54, 33, 0.4);
      font-size: 14px;
      letter-spacing: 0.25em;
      text-indent: 0.25em;
    }

    .hero-main {
      padding: 20px 8px 12px;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
    }

    /* 中央两列竖排主标题，参照设计稿左右排布 */
    .hero-text-columns {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 40px;
      margin-bottom: 30px;
    }

    .vertical-title {
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-family: "SimSun", "Songti SC", "STSong", "Source Han Serif SC",
        "Noto Serif SC", serif; /* 老报宋感 */
      font-weight: 700;
      font-size: 32px;
      letter-spacing: 0.55em;
      color: #8b1e1e; /* 接近图中印章红 */
      text-shadow:
        0 1px 0 rgba(255, 255, 255, 0.85),
        0 3px 6px rgba(0, 0, 0, 0.28);
    }

    .vertical-title-left {
      margin-left: 4px;
    }

    .vertical-title-right {
      margin-right: 4px;
    }

    .hero-subtitle {
      /* 底部年份与校名：使用行楷效果，字号放大一倍 */
      font-family: "STXingkai", "STKaiti", "KaiTi", "KaiTi_GB2312",
        "FangSong", "SimSun", serif;
      font-size: 26px;
      line-height: 1.5;
      color: rgba(75, 54, 33, 0.95);
      letter-spacing: 0.12em;
    }

    .hero-subtitle span {
      display: block;
    }

    /* 原首屏插画不再单独展示 */
    .hero-visual {
      display: none;
    }

    .hero-actions {
      margin-bottom: 48px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .btn-main {
      min-width: 180px;
      padding: 12px 24px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(145deg, #a02727, var(--main-red));
      color: #fef6e6;
      font-family: "KaiTi", "STKaiti", "楷体", serif; /* 楷体 */
      font-size: 15px;
      letter-spacing: 0.2em;
      text-indent: 0.2em;
      box-shadow:
        0 4px 0 rgba(75, 24, 24, 0.9),
        0 8px 14px rgba(75, 54, 33, 0.55);
      cursor: pointer;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
    }

    .btn-main:active {
      transform: translateY(2px) scale(0.97);
      box-shadow:
        0 2px 0 rgba(75, 24, 24, 0.8),
        0 4px 8px rgba(75, 54, 33, 0.4);
    }

    .hero-tip {
      font-size: 11px;
      color: rgba(75, 54, 33, 0.7);
    }

    /* 信纸寄语区 */
    .letter-section {
      position: relative;
    }

    .letter-paper {
      position: relative;
      background: var(--light-paper);
      padding: 18px 14px 20px;
      border-radius: 8px;
      box-shadow:
        0 4px 8px rgba(75, 54, 33, 0.28),
        0 0 0 1px rgba(139, 110, 75, 0.25);
      overflow: hidden;
    }

    .letter-paper::before {
      content: "";
      position: absolute;
      inset: 12px 10px 10px;
      background-image: repeating-linear-gradient(
        to bottom,
        rgba(75, 54, 33, 0.08) 0,
        rgba(75, 54, 33, 0.08) 1px,
        transparent 22px,
        transparent 24px
      );
      pointer-events: none;
      z-index: 0;
    }

    .letter-content {
      position: relative;
      z-index: 1;
      font-size: 13px;
      line-height: 1.8;
      text-indent: 2em;
    }

    .letter-title {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--deep-brown);
      text-indent: 0;
    }

    .letter-hints {
      margin-top: 12px;
      padding-left: 1.6em;
      font-size: 12px;
      color: rgba(75, 54, 33, 0.85);
    }

    .letter-hints li {
      margin-bottom: 4px;
    }

    /* 表单卡片 */
    .form-section {
      margin-top: 18px;
    }

    .form-card {
      background: var(--light-card);
      border-radius: 10px;
      padding: 18px 14px 20px;
      box-shadow:
        0 4px 10px rgba(75, 54, 33, 0.32),
        0 0 0 1px rgba(139, 110, 75, 0.2);
      position: relative;
    }

    .form-card::before {
      content: "";
      position: absolute;
      right: 12px;
      top: 10px;
      width: 40px;
      height: 18px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.08), transparent);
      opacity: 0.4;
      transform: skewX(-12deg);
      pointer-events: none;
    }

    .form-title {
      font-size: 15px;
      margin-bottom: 4px;
      color: var(--deep-brown);
      font-weight: bold;
    }

    .form-subtitle {
      font-size: 12px;
      margin-bottom: 14px;
      color: rgba(75, 54, 33, 0.8);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }

    .form-label {
      margin-bottom: 4px;
      color: rgba(75, 54, 33, 0.9);
    }

    .form-input,
    .form-select,
    .form-textarea {
      border: none;
      border-bottom: 2px solid rgba(75, 54, 33, 0.85);
      padding: 6px 4px 4px;
      font-size: 13px;
      background: transparent;
      outline: none;
      color: var(--ink);
      font-family: inherit;
      -webkit-appearance: none;
      border-radius: 0;
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: rgba(75, 54, 33, 0.4);
    }

    .form-select {
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(75, 54, 33, 0.8) 50%),
        linear-gradient(135deg, rgba(75, 54, 33, 0.8) 50%, transparent 50%);
      background-position:
        calc(100% - 10px) 50%,
        calc(100% - 6px) 50%;
      background-size: 6px 6px;
      background-repeat: no-repeat;
      padding-right: 22px;
    }

    .form-textarea {
      resize: none;
      min-height: 90px;
      line-height: 1.6;
    }

    .cta-wrapper {
      margin-top: 18px;
      display: flex;
      justify-content: center;
    }

    .btn-cta {
      width: 100%;
      max-width: 260px;
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 30% 0, #c25a3a, #8b1e1e);
      color: #fffaf0;
      font-size: 15px;
      letter-spacing: 0.3em;
      text-indent: 0.3em;
      cursor: pointer;
      box-shadow:
        0 5px 0 rgba(75, 38, 21, 0.9),
        0 10px 18px rgba(75, 54, 33, 0.6);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
    }

    .btn-cta:active {
      transform: translateY(2px) scale(0.97);
      box-shadow:
        0 3px 0 rgba(75, 38, 21, 0.85),
        0 5px 10px rgba(75, 54, 33, 0.5);
    }

    /* 祝福墙 */
    .wall-section {
      margin-top: 10px;
    }

    .wall-title {
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--deep-brown);
      letter-spacing: 0.16em;
      text-indent: 0.16em;
    }

    .wall-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* 祝福墙卡片：复古拍立得 / 邮票风格 */
    .wall-item {
      position: relative;
      padding: 14px 14px 18px 32px;
      border-radius: 4px;
      background: linear-gradient(180deg, #fefcf5 0%, #fdf6e6 100%);
      box-shadow:
        0 2px 0 rgba(139, 110, 75, 0.12),
        0 4px 12px rgba(75, 54, 33, 0.22),
        0 0 0 1px rgba(139, 110, 75, 0.2);
      font-size: 12px;
      line-height: 1.6;
      border: 1px solid rgba(139, 110, 75, 0.25);
    }

    .wall-item::before {
      /* 左上角引言引号装饰，突出“金句感” */
      content: "“";
      position: absolute;
      top: -10px;
      left: 6px;
      font-size: 32px;
      color: rgba(139, 30, 30, 0.25);
      font-family: "Songti SC", "STSong", serif;
    }

    .wall-item::after {
      content: "";
      position: absolute;
      right: 8px;
      bottom: 8px;
      width: 20px;
      height: 20px;
      border: 1px dashed rgba(139, 30, 30, 0.45);
      border-radius: 2px;
      opacity: 0.6;
    }

    .wall-meta {
      font-size: 11px;
      color: rgba(75, 54, 33, 0.7);
      margin-bottom: 2px;
    }

    .wall-text {
      font-size: 12px;
      color: var(--deep-brown);
    }

    /* 页脚 */
    .footer {
      margin-top: 20px;
      padding: 12px 4px 4px;
      text-align: center;
      font-size: 11px;
      color: rgba(75, 54, 33, 0.8);
      border-top: 1px dashed rgba(75, 54, 33, 0.55);
      user-select: none;
    }

    /* 区块淡入上滑动画 */
    .fade-up {
      opacity: 0;
      transform: translateY(18px);
      transition: opacity 0.7s ease-out, transform 0.7s ease-out;
    }

    .fade-up.in-view {
      opacity: 1;
      transform: translateY(0);
    }

    /* 精美祝福卡片 / 材料中心弹层通用遮罩 */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .overlay.active {
      display: flex;
    }

    .overlay-card {
      width: 88%;
      max-width: 340px;
      background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.9), #f8f0dc);
      border-radius: 12px;
      padding: 16px 16px 14px;
      position: relative;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      overflow: hidden;
    }

    .overlay-card::before {
      /* 校徽水纹效果，可理解为浅色徽章印记 */
      content: "";
      position: absolute;
      width: 140px;
      height: 140px;
      right: -30px;
      top: -40px;
      border-radius: 50%;
      border: 2px solid rgba(139, 30, 30, 0.3);
      box-shadow:
        0 0 0 8px rgba(139, 30, 30, 0.08),
        0 0 0 16px rgba(139, 30, 30, 0.04);
      opacity: 0.35;
      pointer-events: none;
    }

    .overlay-close {
      position: absolute;
      right: 10px;
      top: 8px;
      border: none;
      background: transparent;
      font-size: 18px;
      color: rgba(75, 54, 33, 0.8);
      cursor: pointer;
      padding: 4px;
    }

    .preview-title {
      font-size: 14px;
      color: var(--deep-brown);
      margin-bottom: 6px;
      padding-right: 32px;
    }

    .preview-name {
      font-size: 13px;
      color: rgba(75, 54, 33, 0.9);
      margin-bottom: 4px;
    }

    .preview-message {
      margin-top: 8px;
      font-size: 13px;
      line-height: 1.7;
      color: var(--deep-brown);
      position: relative;
      padding-left: 18px;
    }

    .preview-message::before,
    .preview-message::after {
      /* 引言双引号装饰，与祝福墙呼应 */
      position: absolute;
      font-size: 18px;
      color: rgba(139, 30, 30, 0.4);
      font-family: "Songti SC", "STSong", serif;
    }

    .preview-message::before {
      content: "“";
      left: 0;
      top: -2px;
    }

    .preview-message::after {
      content: "”";
      right: 4px;
      bottom: -8px;
    }

    .preview-tip {
      margin-top: 10px;
      font-size: 11px;
      color: rgba(75, 54, 33, 0.75);
    }

    /* 材料中心列表样式 */
    .material-title {
      font-size: 14px;
      margin-bottom: 10px;
      color: var(--deep-brown);
    }

    .material-list {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 11px;
      line-height: 1.6;
      border-top: 1px dashed rgba(75, 54, 33, 0.3);
      margin-top: 6px;
    }

    .material-item {
      padding: 6px 0;
      border-bottom: 1px dashed rgba(75, 54, 33, 0.18);
    }

    .material-copy-btn {
      margin-top: 4px;
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(75, 54, 33, 0.6);
      background: rgba(244, 228, 196, 0.9);
      color: var(--deep-brown);
      cursor: pointer;
    }

    /* 隐蔽的材料中心按钮（默认几乎不可见，仅为规范满足“按钮”存在） */
    .material-trigger-btn {
      position: fixed;
      right: 6px;
      bottom: 4px;
      padding: 4px 8px;
      font-size: 10px;
      border-radius: 999px;
      border: 1px solid rgba(75, 54, 33, 0.2);
      background: rgba(244, 228, 196, 0.2);
      color: rgba(75, 54, 33, 0.2);
      z-index: 5;
      opacity: 0.05;         /* 肉眼几乎看不到，仅开发者知晓 */
    }

    @media (max-width: 360px) {
      .hero-title {
        font-size: 20px;
      }

      .hero-visual {
        margin-top: 18px;
      }

      .btn-main {
        min-width: 160px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-inner">
      <!-- 首屏：仅保留背景图与“写下祝福”按钮 -->
      <section class="section hero" id="hero">
        <div class="hero-actions">
          <button class="btn-main" id="scrollToFormBtn">
            写下祝福
          </button>
        </div>
      </section>

      <!-- 校庆寄语信纸区 -->
      <section class="section letter-section">
        <div class="letter-paper fade-up">
          <div class="letter-content">
            <div class="letter-title serif-title">
              致三十年后的我们
            </div>
            <p>
              光阴似箭，三十载春华秋实，校园里的一砖一瓦、一草一木，都藏着无数次清晨的读书声与黄昏的笑语。
              无论此刻的您身在何处，母校始终在这里，悄悄为你的每一次成长鼓掌。
            </p>
            <p>
              请把对母校、对师友、对青春的那一句话写下来，像写在信纸上的小小心意，被温柔地收入这本纪念册中。
            </p>

            <ul class="letter-hints">
              <li>1. 您的心意将被永久收藏。</li>
              <li>2. 祝福墙将会与校庆现场实时同步展示。</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 祝福表单 -->
      <section class="section form-section" id="wish-section">
        <div class="form-card fade-up">
          <div class="form-title serif-title">
            写下一句给母校的悄悄话
          </div>
          <div class="form-subtitle">
            无论是当年的操场、走廊，还是某一扇熟悉的窗，都在等你轻声问候。
          </div>

          <form id="blessingForm">
            <!-- 姓名 -->
            <div class="form-group">
              <label for="name" class="form-label">姓名</label>
              <input
                id="name"
                name="name"
                type="text"
                class="form-input"
                maxlength="20"
                placeholder="例：张三 / 可留昵称" />
            </div>

            <!-- 年份 -->
            <div class="form-group">
              <label for="year" class="form-label">入学或毕业年份</label>
              <input
                id="year"
                name="year"
                type="text"
                class="form-input"
                maxlength="10"
                placeholder="例：1999 级 / 2015 届" />
            </div>

            <!-- 身份 -->
            <div class="form-group">
              <label for="identity" class="form-label">身份</label>
              <select id="identity" name="identity" class="form-select">
                <option value="">请选择您的身份</option>
                <option value="在校生">在校生</option>
                <option value="校友">校友</option>
                <option value="教师">教师</option>
                <option value="家长">家长</option>
                <option value="工作人员">学校工作人员</option>
                <option value="其他">其他</option>
              </select>
            </div>

            <!-- 关键词 -->
            <div class="form-group">
              <label for="category" class="form-label">关键词</label>
              <select id="category" name="category" class="form-select">
                <option value="">请选择一个关键词</option>
                <option value="求学往事">求学往事</option>
                <option value="恩师难忘">恩师难忘</option>
                <option value="校园风景">校园风景</option>
                <option value="寄语未来">寄语未来</option>
                <option value="其他">其他</option>
              </select>
            </div>

            <!-- 寄语 -->
            <div class="form-group">
              <label for="content" class="form-label">寄语</label>
              <textarea
                id="content"
                name="content"
                class="form-textarea"
                maxlength="200"
                placeholder="哪位老师或哪处校园风景最让你魂牵梦萦？请把那一幕、那一句话，悄悄写给母校……"></textarea>
            </div>

            <div class="cta-wrapper">
              <button type="submit" class="btn-cta">
                提交感言
              </button>
            </div>
          </form>
        </div>
      </section>

      <!-- 祝福墙（报道选题金句区） -->
      <section class="section wall-section">
        <div class="wall-title serif-title">
          校庆祝福墙 · 金句速览
        </div>
        <div class="wall-list" id="wishWall">
          <!-- JS 动态插入祝福卡片 -->
        </div>
      </section>

      <!-- 页脚（长按触发材料中心） -->
      <footer class="footer" id="pageFooter">
        无锡外国语学校
      </footer>
    </div>
  </div>

  <!-- 精美祝福卡片预览弹层 -->
  <div class="overlay" id="previewOverlay">
    <div class="overlay-card">
      <button class="overlay-close" id="previewCloseBtn" aria-label="关闭预览">×</button>
      <div class="preview-title serif-title">
        校庆祝福 · 报道素材预览
      </div>
      <div class="preview-name" id="previewName"></div>
      <div class="preview-message" id="previewMessage"></div>
      <div class="preview-tip">
        感谢您为 30 周年校庆报道贡献素材。<br />
        您的这句真心话，或许会成为下一篇报道的标题。
      </div>
    </div>
  </div>

  <!-- 材料中心弹层（仅通过隐蔽入口打开） -->
  <div class="overlay" id="materialOverlay">
    <div class="overlay-card">
      <button class="overlay-close" id="materialCloseBtn" aria-label="关闭材料中心">×</button>
      <div class="material-title serif-title">
        材料中心 · 已收集祝福
      </div>
      <button class="material-copy-btn" id="copyAllBtn">
        一键复制全部文本
      </button>
      <div class="material-list" id="materialList">
        <!-- JS 动态生成列表，便于直接复制进 Word -->
      </div>
    </div>
  </div>

  <!-- 隐蔽的材料中心按钮（满足“按钮”存在的显式要求） -->
  <button id="materialTriggerBtn" class="material-trigger-btn" title="材料中心">
    材料中心
  </button>

  <script>
    // ================
    // Supabase 客户端
    // ================
    var SUPABASE_URL = "https://wqcgfoesufaagibytkhz.supabase.co";
    var SUPABASE_ANON_KEY = "sb_publishable_TVPxw4ML1bEivsMwJFnb3g_TlmKC7nj";
    var _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ================
    // 状态与工具方法
    // ================
    // 用数组在前端暂存所有祝福（含从 DB 加载的 + 本地新提交的）
    var wishes = [];

    /**
     * 初始化读取：从 Supabase 拉取已审核通过的祝福并渲染到祝福墙
     */
    function fetchBlessings() {
      var wall = document.getElementById("wishWall");
      if (wall) {
        wall.innerHTML = ""; /* 清空旧内容，防止数据重复显示 */
      }

      _supabase
        .from("blessings")
        .select("*")
        .eq("is_approved", true)
        .order("created_at", { ascending: false })
        .then(function (result) {
          if (result.error) {
            console.error("加载祝福墙失败：", result.error);
            return;
          }
          wishes = result.data || [];
          renderWishWall();
          renderMaterialCenterList();
        })
        .catch(function (err) {
          console.error("加载祝福墙失败：", err);
        });
    }

    /* 页面加载完成时调用 */
    window.onload = function () {
      fetchBlessings();
    };

    // 将祝福渲染到祝福墙
    function renderWishWall() {
      var wall = document.getElementById("wishWall");
      if (!wall) return;
      wall.innerHTML = "";

      wishes.forEach(function (item, index) {
        var card = document.createElement("div");
        card.className = "wall-item";

        var meta = document.createElement("div");
        meta.className = "wall-meta";

        var metaParts = [];
        if (item.name) metaParts.push(item.name);
        if (item.year) metaParts.push(item.year);
        if (item.identity && item.identity !== "未填写") metaParts.push(item.identity);
        if (item.category && item.category !== "未选择") metaParts.push("关键词：" + item.category);

        meta.textContent = (index + 1) + ". " + (metaParts.join(" · ") || "匿名校友");
        var text = document.createElement("div");
        text.className = "wall-text";
        text.textContent = item.content || item.message || "";

        card.appendChild(meta);
        card.appendChild(text);
        wall.appendChild(card);
      });
    }

    // 将祝福渲染为文本块，供材料中心复制
    function buildMaterialText() {
      return wishes
        .map(function (item, index) {
          var line = [];
          line.push((index + 1) + ".");
          if (item.name) line.push("姓名：" + item.name);
          if (item.year) line.push("年份：" + item.year);
          if (item.identity && item.identity !== "未填写") line.push("身份：" + item.identity);
          if (item.category && item.category !== "未选择") line.push("关键词：" + item.category);
          line.push("寄语：" + (item.content || item.message || ""));
          return line.join("  ");
        })
        .join("\n\n");
    }

    // ======================
    // 首屏按钮滚动到表单区
    // ======================
    (function () {
      var scrollBtn = document.getElementById("scrollToFormBtn");
      var wishSection = document.getElementById("wish-section");

      if (scrollBtn && wishSection) {
        scrollBtn.addEventListener("click", function () {
          wishSection.scrollIntoView({
            behavior: "smooth",
            block: "start"
          });
        });
      }
    })();

    // ===========
    // 淡入动画
    // ===========
    (function () {
      var fadeEls = document.querySelectorAll(".fade-up");
      if (!("IntersectionObserver" in window)) {
        fadeEls.forEach(function (el) {
          el.classList.add("in-view");
        });
        return;
      }

      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            entry.target.classList.add("in-view");
            observer.unobserve(entry.target);
          }
        });
      }, {
        threshold: 0.15
      });

      fadeEls.forEach(function (el) {
        observer.observe(el);
      });
    })();

    // ======================
    // 表单提交
    // ======================
    (function () {
      var form = document.getElementById("blessingForm");
      if (!form) return;

      form.addEventListener("submit", function (event) {
        handleSubmit(event);
      });
    })();

    // 打开祝福预览弹层
    function openPreview(data) {
      var overlay = document.getElementById("previewOverlay");
      var nameEl = document.getElementById("previewName");
      var msgEl = document.getElementById("previewMessage");
      if (!overlay || !nameEl || !msgEl) return;

      var metaParts = [];
      if (data.name) metaParts.push(data.name);
      if (data.year) metaParts.push(data.year);
      if (data.identity && data.identity !== "未填写") metaParts.push(data.identity);
      if (data.category && data.category !== "未选择") metaParts.push("关键词：" + data.category);
      nameEl.textContent = metaParts.join(" · ");
      msgEl.textContent = data.content || data.message || "";

      overlay.classList.add("active");
    }

    // 关闭预览弹层
    (function () {
      var overlay = document.getElementById("previewOverlay");
      var closeBtn = document.getElementById("previewCloseBtn");

      function close() {
        if (overlay) overlay.classList.remove("active");
      }

      if (closeBtn) {
        closeBtn.addEventListener("click", close);
      }

      if (overlay) {
        overlay.addEventListener("click", function (e) {
          if (e.target === overlay) {
            close();
          }
        });
      }
    })();

    /**
     * 表单提交：将数据存入 Supabase blessings 表
     */
    async function handleSubmit(event) {
      event.preventDefault();

      var formData = {
        name: document.getElementById("name").value,
        year: document.getElementById("year").value,
        identity: document.getElementById("identity").value,
        content: document.getElementById("content").value,
        category: document.getElementById("category") ? document.getElementById("category").value : "祝福",
        is_approved: false
      };

      console.log("准备提交的数据:", formData);

      var result = await _supabase
        .from("blessings")
        .insert([formData]);

      if (result.error) {
        console.error("提交失败详情:", result.error);
        alert("提交失败，错误信息：" + result.error.message);
      } else {
        console.log("提交成功:", result.data);
        alert("感谢您的祝福！您的感言已进入审核库。");
        document.getElementById("blessingForm").reset();
      }
    }

    // ==================
    // 材料中心（长按）
    // ==================
    var materialOverlay = document.getElementById("materialOverlay");
    var materialCloseBtn = document.getElementById("materialCloseBtn");
    var materialListEl = document.getElementById("materialList");
    var copyAllBtn = document.getElementById("copyAllBtn");
    var materialTriggerBtn = document.getElementById("materialTriggerBtn");
    var footer = document.getElementById("pageFooter");

    // 渲染材料中心列表
    function renderMaterialCenterList() {
      if (!materialListEl) return;
      materialListEl.innerHTML = "";

      wishes.forEach(function (item, index) {
        var div = document.createElement("div");
        div.className = "material-item";
        div.textContent =
          (index + 1) + ". " +
          (item.name ? "姓名：" + item.name + "  " : "") +
          (item.year ? "年份：" + item.year + "  " : "") +
          (item.identity && item.identity !== "未填写" ? "身份：" + item.identity + "  " : "") +
          (item.category && item.category !== "未选择" ? "关键词：" + item.category + "  " : "") +
          "寄语：" + (item.content || item.message || "");
        materialListEl.appendChild(div);
      });

      if (!wishes.length) {
        var empty = document.createElement("div");
        empty.style.padding = "6px 0";
        empty.style.fontSize = "11px";
        empty.style.color = "rgba(75,54,33,0.7)";
        empty.textContent = "尚未收集到祝福内容，可在现场演示时逐条累积。";
        materialListEl.appendChild(empty);
      }
    }

    function openMaterialCenter() {
      if (materialOverlay) {
        renderMaterialCenterList();
        materialOverlay.classList.add("active");
      }
    }

    function closeMaterialCenter() {
      if (materialOverlay) {
        materialOverlay.classList.remove("active");
      }
    }

    if (materialCloseBtn) {
      materialCloseBtn.addEventListener("click", closeMaterialCenter);
    }

    if (materialOverlay) {
      materialOverlay.addEventListener("click", function (e) {
        if (e.target === materialOverlay) closeMaterialCenter();
      });
    }

    // 一键复制全部内容到剪贴板，方便粘贴进 Word
    if (copyAllBtn) {
      copyAllBtn.addEventListener("click", function () {
        var text = buildMaterialText() || "（当前暂无祝福数据）";
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text)
            .then(function () {
              alert("已复制全部祝福内容，可直接粘贴到 Word 报道文档中。");
            })
            .catch(function () {
              alert("复制失败，可尝试手动全选复制。");
            });
        } else {
          // 旧浏览器兜底：直接弹出提示，配合手动复制
          alert("当前浏览器不支持自动复制，请在材料中心中手动长按选择复制。");
        }
      });
    }

    // 材料中心按钮点击也可打开（你自己知道按钮在哪即可）
    if (materialTriggerBtn) {
      materialTriggerBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        openMaterialCenter();
      });
    }

    // 页脚长按 1.5 秒，打开材料中心（对普通用户来说不易误触）
    (function () {
      if (!footer) return;
      var pressTimer = null;

      function startPress() {
        if (pressTimer !== null) return;
        pressTimer = window.setTimeout(function () {
          openMaterialCenter();
        }, 1500); // 长按 1.5 秒触发
      }

      function cancelPress() {
        if (pressTimer !== null) {
          clearTimeout(pressTimer);
          pressTimer = null;
        }
      }

      footer.addEventListener("touchstart", startPress);
      footer.addEventListener("touchend", cancelPress);
      footer.addEventListener("touchmove", cancelPress);
      footer.addEventListener("mousedown", startPress);
      footer.addEventListener("mouseup", cancelPress);
      footer.addEventListener("mouseleave", cancelPress);
    })();
  </script>
</body>
</html>